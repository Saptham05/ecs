AWSTemplateFormatVersion: '2010-09-09'
Description: 'Enhanced ECS Task Definition with 40 Environment Variables, 20 Secrets, and Advanced Sidecar Configuration'
Parameters:
  TaskDefinitionFamily: {Type: String, Default: my-application-task}
  LaunchType: {Type: String, Default: FARGATE, AllowedValues: [FARGATE, EC2, EXTERNAL]}
  TaskCpu: {Type: String, Default: '512', AllowedValues: ['256','512','1024','2048','4096','8192','16384']}
  TaskMemory: {Type: String, Default: '1GB'}
  CreateTaskRole: {Type: String, Default: 'false', AllowedValues: ['true','false']}
  ExistingTaskRoleArn: {Type: String, Default: ''}
  CreateExecutionRole: {Type: String, Default: 'true', AllowedValues: ['true','false']}
  ExistingExecutionRoleArn: {Type: String, Default: ''}
  NetworkMode: {Type: String, Default: awsvpc, AllowedValues: [awsvpc, bridge, host, none]}
  OperatingSystem: {Type: String, Default: LINUX, AllowedValues: [LINUX, WINDOWS_SERVER_2019_FULL, WINDOWS_SERVER_2019_CORE, WINDOWS_SERVER_2022_FULL, WINDOWS_SERVER_2022_CORE, WINDOWS_SERVER_2025_FULL, WINDOWS_SERVER_2025_CORE]}
  CpuArchitecture: {Type: String, Default: X86_64, AllowedValues: [X86_64, ARM64]}
  Container1Name: {Type: String, Default: app-container}
  Container1Image: {Type: String, Default: 'nginx:latest'}
  Container1Cpu: {Type: Number, Default: 256, MinValue: 0}
  Container1Memory: {Type: Number, Default: 512, MinValue: 4}
  Container1MemoryReservation: {Type: Number, Default: 256, MinValue: 0}
  Container1Essential: {Type: String, Default: 'true', AllowedValues: ['true','false']}
  Container1Port: {Type: Number, Default: 80, MinValue: 0, MaxValue: 65535}
  Container1PortName: {Type: String, Default: ''}
  Container1Protocol: {Type: String, Default: tcp, AllowedValues: [tcp, udp]}
  Container1AppProtocol: {Type: String, Default: '', AllowedValues: ['', http, http2, grpc]}
  EnableLogging: {Type: String, Default: 'true', AllowedValues: ['true','false']}
  LogGroupName: {Type: String, Default: /ecs/my-application}
  LogStreamPrefix: {Type: String, Default: ecs}
  LogRetentionDays: {Type: Number, Default: 7, AllowedValues: [1,3,5,7,14,30,60,90,120,150,180,365,400,545,731,1827,3653]}
  LogDriverMode: {Type: String, Default: non-blocking, AllowedValues: [blocking, non-blocking]}
  EnableLogGroupAutoCreate: {Type: String, Default: 'true', AllowedValues: ['true','false']}
  EnableHealthCheck: {Type: String, Default: 'false', AllowedValues: ['true','false']}
  HealthCheckCommand: {Type: String, Default: 'CMD-SHELL, curl -f http://localhost/ || exit 1'}
  HealthCheckInterval: {Type: Number, Default: 30, MinValue: 5, MaxValue: 300}
  HealthCheckTimeout: {Type: Number, Default: 5, MinValue: 2, MaxValue: 60}
  HealthCheckRetries: {Type: Number, Default: 3, MinValue: 1, MaxValue: 10}
  HealthCheckStartPeriod: {Type: Number, Default: 0, MinValue: 0, MaxValue: 300}
  Environment1Key: {Type: String, Default: ''}
  Environment1Value: {Type: String, Default: ''}
  Environment2Key: {Type: String, Default: ''}
  Environment2Value: {Type: String, Default: ''}
  Environment3Key: {Type: String, Default: ''}
  Environment3Value: {Type: String, Default: ''}
  Environment4Key: {Type: String, Default: ''}
  Environment4Value: {Type: String, Default: ''}
  Environment5Key: {Type: String, Default: ''}
  Environment5Value: {Type: String, Default: ''}
  Environment6Key: {Type: String, Default: ''}
  Environment6Value: {Type: String, Default: ''}
  Environment7Key: {Type: String, Default: ''}
  Environment7Value: {Type: String, Default: ''}
  Environment8Key: {Type: String, Default: ''}
  Environment8Value: {Type: String, Default: ''}
  Environment9Key: {Type: String, Default: ''}
  Environment9Value: {Type: String, Default: ''}
  Environment10Key: {Type: String, Default: ''}
  Environment10Value: {Type: String, Default: ''}
  Environment11Key: {Type: String, Default: ''}
  Environment11Value: {Type: String, Default: ''}
  Environment12Key: {Type: String, Default: ''}
  Environment12Value: {Type: String, Default: ''}
  Environment13Key: {Type: String, Default: ''}
  Environment13Value: {Type: String, Default: ''}
  Environment14Key: {Type: String, Default: ''}
  Environment14Value: {Type: String, Default: ''}
  Environment15Key: {Type: String, Default: ''}
  Environment15Value: {Type: String, Default: ''}
  Environment16Key: {Type: String, Default: ''}
  Environment16Value: {Type: String, Default: ''}
  Environment17Key: {Type: String, Default: ''}
  Environment17Value: {Type: String, Default: ''}
  Environment18Key: {Type: String, Default: ''}
  Environment18Value: {Type: String, Default: ''}
  Environment19Key: {Type: String, Default: ''}
  Environment19Value: {Type: String, Default: ''}
  Environment20Key: {Type: String, Default: ''}
  Environment20Value: {Type: String, Default: ''}
  Environment21Key: {Type: String, Default: ''}
  Environment21Value: {Type: String, Default: ''}
  Environment22Key: {Type: String, Default: ''}
  Environment22Value: {Type: String, Default: ''}
  Environment23Key: {Type: String, Default: ''}
  Environment23Value: {Type: String, Default: ''}
  Environment24Key: {Type: String, Default: ''}
  Environment24Value: {Type: String, Default: ''}
  Environment25Key: {Type: String, Default: ''}
  Environment25Value: {Type: String, Default: ''}
  Environment26Key: {Type: String, Default: ''}
  Environment26Value: {Type: String, Default: ''}
  Environment27Key: {Type: String, Default: ''}
  Environment27Value: {Type: String, Default: ''}
  Environment28Key: {Type: String, Default: ''}
  Environment28Value: {Type: String, Default: ''}
  Environment29Key: {Type: String, Default: ''}
  Environment29Value: {Type: String, Default: ''}
  Environment30Key: {Type: String, Default: ''}
  Environment30Value: {Type: String, Default: ''}
  Environment31Key: {Type: String, Default: ''}
  Environment31Value: {Type: String, Default: ''}
  Environment32Key: {Type: String, Default: ''}
  Environment32Value: {Type: String, Default: ''}
  Environment33Key: {Type: String, Default: ''}
  Environment33Value: {Type: String, Default: ''}
  Environment34Key: {Type: String, Default: ''}
  Environment34Value: {Type: String, Default: ''}
  Environment35Key: {Type: String, Default: ''}
  Environment35Value: {Type: String, Default: ''}
  Environment36Key: {Type: String, Default: ''}
  Environment36Value: {Type: String, Default: ''}
  Environment37Key: {Type: String, Default: ''}
  Environment37Value: {Type: String, Default: ''}
  Environment38Key: {Type: String, Default: ''}
  Environment38Value: {Type: String, Default: ''}
  Environment39Key: {Type: String, Default: ''}
  Environment39Value: {Type: String, Default: ''}
  Environment40Key: {Type: String, Default: ''}
  Environment40Value: {Type: String, Default: ''}
  Secret1Name: {Type: String, Default: ''}
  Secret1ValueFrom: {Type: String, Default: ''}
  Secret2Name: {Type: String, Default: ''}
  Secret2ValueFrom: {Type: String, Default: ''}
  Secret3Name: {Type: String, Default: ''}
  Secret3ValueFrom: {Type: String, Default: ''}
  Secret4Name: {Type: String, Default: ''}
  Secret4ValueFrom: {Type: String, Default: ''}
  Secret5Name: {Type: String, Default: ''}
  Secret5ValueFrom: {Type: String, Default: ''}
  Secret6Name: {Type: String, Default: ''}
  Secret6ValueFrom: {Type: String, Default: ''}
  Secret7Name: {Type: String, Default: ''}
  Secret7ValueFrom: {Type: String, Default: ''}
  Secret8Name: {Type: String, Default: ''}
  Secret8ValueFrom: {Type: String, Default: ''}
  Secret9Name: {Type: String, Default: ''}
  Secret9ValueFrom: {Type: String, Default: ''}
  Secret10Name: {Type: String, Default: ''}
  Secret10ValueFrom: {Type: String, Default: ''}
  Secret11Name: {Type: String, Default: ''}
  Secret11ValueFrom: {Type: String, Default: ''}
  Secret12Name: {Type: String, Default: ''}
  Secret12ValueFrom: {Type: String, Default: ''}
  Secret13Name: {Type: String, Default: ''}
  Secret13ValueFrom: {Type: String, Default: ''}
  Secret14Name: {Type: String, Default: ''}
  Secret14ValueFrom: {Type: String, Default: ''}
  Secret15Name: {Type: String, Default: ''}
  Secret15ValueFrom: {Type: String, Default: ''}
  Secret16Name: {Type: String, Default: ''}
  Secret16ValueFrom: {Type: String, Default: ''}
  Secret17Name: {Type: String, Default: ''}
  Secret17ValueFrom: {Type: String, Default: ''}
  Secret18Name: {Type: String, Default: ''}
  Secret18ValueFrom: {Type: String, Default: ''}
  Secret19Name: {Type: String, Default: ''}
  Secret19ValueFrom: {Type: String, Default: ''}
  Secret20Name: {Type: String, Default: ''}
  Secret20ValueFrom: {Type: String, Default: ''}
  EnableEfsVolume: {Type: String, Default: 'false', AllowedValues: ['true','false']}
  EfsVolumeId: {Type: String, Default: ''}
  EfsRootDirectory: {Type: String, Default: /}
  EfsMountPath: {Type: String, Default: /mnt/efs}
  EfsTransitEncryption: {Type: String, Default: ENABLED, AllowedValues: [ENABLED, DISABLED]}
  EphemeralStorageSize: {Type: Number, Default: 21, MinValue: 20, MaxValue: 200}
  EnableSidecar: {Type: String, Default: 'false', AllowedValues: ['true','false']}
  SidecarName: {Type: String, Default: sidecar-container}
  SidecarImage: {Type: String, Default: 'amazon/aws-for-fluent-bit:latest'}
  SidecarCpu: {Type: Number, Default: 128, MinValue: 0}
  SidecarMemory: {Type: Number, Default: 256, MinValue: 4}
  SidecarEssential: {Type: String, Default: 'false', AllowedValues: ['true','false']}
  SidecarCommand: {Type: String, Default: ''}
  SidecarPort1: {Type: Number, Default: 0, MinValue: 0, MaxValue: 65535}
  SidecarPort1Name: {Type: String, Default: ''}
  SidecarPort1Protocol: {Type: String, Default: tcp, AllowedValues: [tcp, udp]}
  SidecarPort2: {Type: Number, Default: 0, MinValue: 0, MaxValue: 65535}
  SidecarPort2Name: {Type: String, Default: ''}
  SidecarPort2Protocol: {Type: String, Default: tcp, AllowedValues: [tcp, udp]}
  SidecarLogGroupName: {Type: String, Default: ''}
  SidecarLogStreamPrefix: {Type: String, Default: sidecar}
  SidecarDependsOnCondition: {Type: String, Default: START, AllowedValues: [START, COMPLETE, SUCCESS, HEALTHY]}
  SidecarEnv1Key: {Type: String, Default: ''}
  SidecarEnv1Value: {Type: String, Default: ''}
  SidecarEnv2Key: {Type: String, Default: ''}
  SidecarEnv2Value: {Type: String, Default: ''}
  SidecarEnv3Key: {Type: String, Default: ''}
  SidecarEnv3Value: {Type: String, Default: ''}
  SidecarEnv4Key: {Type: String, Default: ''}
  SidecarEnv4Value: {Type: String, Default: ''}
  SidecarEnv5Key: {Type: String, Default: ''}
  SidecarEnv5Value: {Type: String, Default: ''}
  SidecarEnv6Key: {Type: String, Default: ''}
  SidecarEnv6Value: {Type: String, Default: ''}
  SidecarEnv7Key: {Type: String, Default: ''}
  SidecarEnv7Value: {Type: String, Default: ''}
  SidecarEnv8Key: {Type: String, Default: ''}
  SidecarEnv8Value: {Type: String, Default: ''}
  SidecarEnv9Key: {Type: String, Default: ''}
  SidecarEnv9Value: {Type: String, Default: ''}
  SidecarEnv10Key: {Type: String, Default: ''}
  SidecarEnv10Value: {Type: String, Default: ''}
  NoFileUlimitSoft: {Type: Number, Default: 65535, MinValue: 1024}
  NoFileUlimitHard: {Type: Number, Default: 65535, MinValue: 1024}
  Environment: {Type: String, Default: development, AllowedValues: [development, qa, staging, perf, production]}
  Project: {Type: String, Default: my-project}
  Owner: {Type: String, Default: platform-team}
Conditions:
  CreateNewTaskRole: !Equals [!Ref CreateTaskRole, 'true']
  CreateNewExecutionRole: !Equals [!Ref CreateExecutionRole, 'true']
  UseExistingTaskRole: !Not [!Equals [!Ref ExistingTaskRoleArn, '']]
  UseExistingExecutionRole: !Not [!Equals [!Ref ExistingExecutionRoleArn, '']]
  EnableLoggingCondition: !Equals [!Ref EnableLogging, 'true']
  EnableHealthCheckCondition: !Equals [!Ref EnableHealthCheck, 'true']
  AddEnvironment1: !Not [!Equals [!Ref Environment1Key, '']]
  AddEnvironment2: !Not [!Equals [!Ref Environment2Key, '']]
  AddEnvironment3: !Not [!Equals [!Ref Environment3Key, '']]
  AddEnvironment4: !Not [!Equals [!Ref Environment4Key, '']]
  AddEnvironment5: !Not [!Equals [!Ref Environment5Key, '']]
  AddEnvironment6: !Not [!Equals [!Ref Environment6Key, '']]
  AddEnvironment7: !Not [!Equals [!Ref Environment7Key, '']]
  AddEnvironment8: !Not [!Equals [!Ref Environment8Key, '']]
  AddEnvironment9: !Not [!Equals [!Ref Environment9Key, '']]
  AddEnvironment10: !Not [!Equals [!Ref Environment10Key, '']]
  AddEnvironment11: !Not [!Equals [!Ref Environment11Key, '']]
  AddEnvironment12: !Not [!Equals [!Ref Environment12Key, '']]
  AddEnvironment13: !Not [!Equals [!Ref Environment13Key, '']]
  AddEnvironment14: !Not [!Equals [!Ref Environment14Key, '']]
  AddEnvironment15: !Not [!Equals [!Ref Environment15Key, '']]
  AddEnvironment16: !Not [!Equals [!Ref Environment16Key, '']]
  AddEnvironment17: !Not [!Equals [!Ref Environment17Key, '']]
  AddEnvironment18: !Not [!Equals [!Ref Environment18Key, '']]
  AddEnvironment19: !Not [!Equals [!Ref Environment19Key, '']]
  AddEnvironment20: !Not [!Equals [!Ref Environment20Key, '']]
  AddEnvironment21: !Not [!Equals [!Ref Environment21Key, '']]
  AddEnvironment22: !Not [!Equals [!Ref Environment22Key, '']]
  AddEnvironment23: !Not [!Equals [!Ref Environment23Key, '']]
  AddEnvironment24: !Not [!Equals [!Ref Environment24Key, '']]
  AddEnvironment25: !Not [!Equals [!Ref Environment25Key, '']]
  AddEnvironment26: !Not [!Equals [!Ref Environment26Key, '']]
  AddEnvironment27: !Not [!Equals [!Ref Environment27Key, '']]
  AddEnvironment28: !Not [!Equals [!Ref Environment28Key, '']]
  AddEnvironment29: !Not [!Equals [!Ref Environment29Key, '']]
  AddEnvironment30: !Not [!Equals [!Ref Environment30Key, '']]
  AddEnvironment31: !Not [!Equals [!Ref Environment31Key, '']]
  AddEnvironment32: !Not [!Equals [!Ref Environment32Key, '']]
  AddEnvironment33: !Not [!Equals [!Ref Environment33Key, '']]
  AddEnvironment34: !Not [!Equals [!Ref Environment34Key, '']]
  AddEnvironment35: !Not [!Equals [!Ref Environment35Key, '']]
  AddEnvironment36: !Not [!Equals [!Ref Environment36Key, '']]
  AddEnvironment37: !Not [!Equals [!Ref Environment37Key, '']]
  AddEnvironment38: !Not [!Equals [!Ref Environment38Key, '']]
  AddEnvironment39: !Not [!Equals [!Ref Environment39Key, '']]
  AddEnvironment40: !Not [!Equals [!Ref Environment40Key, '']]
  AddSecret1: !Not [!Equals [!Ref Secret1Name, '']]
  AddSecret2: !Not [!Equals [!Ref Secret2Name, '']]
  AddSecret3: !Not [!Equals [!Ref Secret3Name, '']]
  AddSecret4: !Not [!Equals [!Ref Secret4Name, '']]
  AddSecret5: !Not [!Equals [!Ref Secret5Name, '']]
  AddSecret6: !Not [!Equals [!Ref Secret6Name, '']]
  AddSecret7: !Not [!Equals [!Ref Secret7Name, '']]
  AddSecret8: !Not [!Equals [!Ref Secret8Name, '']]
  AddSecret9: !Not [!Equals [!Ref Secret9Name, '']]
  AddSecret10: !Not [!Equals [!Ref Secret10Name, '']]
  AddSecret11: !Not [!Equals [!Ref Secret11Name, '']]
  AddSecret12: !Not [!Equals [!Ref Secret12Name, '']]
  AddSecret13: !Not [!Equals [!Ref Secret13Name, '']]
  AddSecret14: !Not [!Equals [!Ref Secret14Name, '']]
  AddSecret15: !Not [!Equals [!Ref Secret15Name, '']]
  AddSecret16: !Not [!Equals [!Ref Secret16Name, '']]
  AddSecret17: !Not [!Equals [!Ref Secret17Name, '']]
  AddSecret18: !Not [!Equals [!Ref Secret18Name, '']]
  AddSecret19: !Not [!Equals [!Ref Secret19Name, '']]
  AddSecret20: !Not [!Equals [!Ref Secret20Name, '']]
  AddSidecarEnv1: !Not [!Equals [!Ref SidecarEnv1Key, '']]
  AddSidecarEnv2: !Not [!Equals [!Ref SidecarEnv2Key, '']]
  AddSidecarEnv3: !Not [!Equals [!Ref SidecarEnv3Key, '']]
  AddSidecarEnv4: !Not [!Equals [!Ref SidecarEnv4Key, '']]
  AddSidecarEnv5: !Not [!Equals [!Ref SidecarEnv5Key, '']]
  AddSidecarEnv6: !Not [!Equals [!Ref SidecarEnv6Key, '']]
  AddSidecarEnv7: !Not [!Equals [!Ref SidecarEnv7Key, '']]
  AddSidecarEnv8: !Not [!Equals [!Ref SidecarEnv8Key, '']]
  AddSidecarEnv9: !Not [!Equals [!Ref SidecarEnv9Key, '']]
  AddSidecarEnv10: !Not [!Equals [!Ref SidecarEnv10Key, '']]
  EnableEfsVolumeCondition: !Equals [!Ref EnableEfsVolume, 'true']
  EnableSidecarCondition: !Equals [!Ref EnableSidecar, 'true']
  IsFargate: !Equals [!Ref LaunchType, 'FARGATE']
  HasSidecarCommand: !Not [!Equals [!Ref SidecarCommand, '']]
  HasSidecarPort1: !Not [!Equals [!Ref SidecarPort1, 0]]
  HasSidecarPort2: !Not [!Equals [!Ref SidecarPort2, 0]]
  HasSeparateSidecarLogGroup: !Not [!Equals [!Ref SidecarLogGroupName, '']]
  HasContainer1PortName: !Not [!Equals [!Ref Container1PortName, '']]
  HasContainer1AppProtocol: !Not [!Equals [!Ref Container1AppProtocol, '']]
Resources:
  LogGroup:
    Type: AWS::Logs::LogGroup
    Condition: EnableLoggingCondition
    Properties: {LogGroupName: !Ref LogGroupName, RetentionInDays: !Ref LogRetentionDays}
  SidecarLogGroup:
    Type: AWS::Logs::LogGroup
    Condition: HasSeparateSidecarLogGroup
    Properties: {LogGroupName: !Ref SidecarLogGroupName, RetentionInDays: !Ref LogRetentionDays}
  TaskRole:
    Type: AWS::IAM::Role
    Condition: CreateNewTaskRole
    Properties:
      RoleName: !Sub '${TaskDefinitionFamily}-task-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement: [{Effect: Allow, Principal: {Service: ecs-tasks.amazonaws.com}, Action: 'sts:AssumeRole'}]
      ManagedPolicyArns: ['arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy']
      Policies:
        - PolicyName: TaskRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - {Effect: Allow, Action: ['s3:GetObject','s3:ListBucket'], Resource: '*'}
              - {Effect: Allow, Action: ['dynamodb:GetItem','dynamodb:PutItem','dynamodb:Query','dynamodb:Scan'], Resource: '*'}
      Tags: [{Key: Name, Value: !Sub '${TaskDefinitionFamily}-task-role'},{Key: Environment, Value: !Ref Environment},{Key: Project, Value: !Ref Project}]
  ExecutionRole:
    Type: AWS::IAM::Role
    Condition: CreateNewExecutionRole
    Properties:
      RoleName: !Sub '${TaskDefinitionFamily}-execution-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement: [{Effect: Allow, Principal: {Service: ecs-tasks.amazonaws.com}, Action: 'sts:AssumeRole'}]
      ManagedPolicyArns: ['arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy']
      Policies:
        - PolicyName: ExecutionRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - {Effect: Allow, Action: ['ecr:GetAuthorizationToken','ecr:BatchCheckLayerAvailability','ecr:GetDownloadUrlForLayer','ecr:BatchGetImage'], Resource: '*'}
              - {Effect: Allow, Action: ['logs:CreateLogStream','logs:PutLogEvents','logs:CreateLogGroup'], Resource: '*'}
              - {Effect: Allow, Action: ['secretsmanager:GetSecretValue'], Resource: '*'}
              - {Effect: Allow, Action: ['ssm:GetParameters','ssm:GetParameter'], Resource: '*'}
      Tags: [{Key: Name, Value: !Sub '${TaskDefinitionFamily}-execution-role'},{Key: Environment, Value: !Ref Environment},{Key: Project, Value: !Ref Project}]
  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Ref TaskDefinitionFamily
      RequiresCompatibilities: [!Ref LaunchType]
      NetworkMode: !Ref NetworkMode
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      RuntimePlatform: {OperatingSystemFamily: !Ref OperatingSystem, CpuArchitecture: !Ref CpuArchitecture}
      TaskRoleArn: !If [CreateNewTaskRole, !GetAtt TaskRole.Arn, !If [UseExistingTaskRole, !Ref ExistingTaskRoleArn, !Ref 'AWS::NoValue']]
      ExecutionRoleArn: !If [CreateNewExecutionRole, !GetAtt ExecutionRole.Arn, !If [UseExistingExecutionRole, !Ref ExistingExecutionRoleArn, !Ref 'AWS::NoValue']]
      EphemeralStorage: !If [IsFargate, {SizeInGiB: !Ref EphemeralStorageSize}, !Ref 'AWS::NoValue']
      ContainerDefinitions:
        - Name: !Ref Container1Name
          Image: !Ref Container1Image
          Cpu: !Ref Container1Cpu
          Memory: !Ref Container1Memory
          MemoryReservation: !Ref Container1MemoryReservation
          Essential: !Ref Container1Essential
          PortMappings: [{ContainerPort: !Ref Container1Port, Protocol: !Ref Container1Protocol, Name: !If [HasContainer1PortName, !Ref Container1PortName, !Ref 'AWS::NoValue'], AppProtocol: !If [HasContainer1AppProtocol, !Ref Container1AppProtocol, !Ref 'AWS::NoValue']}]
          Environment: !If
            - AddEnvironment1
            - - !If [AddEnvironment1, {Name: !Ref Environment1Key, Value: !Ref Environment1Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment2, {Name: !Ref Environment2Key, Value: !Ref Environment2Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment3, {Name: !Ref Environment3Key, Value: !Ref Environment3Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment4, {Name: !Ref Environment4Key, Value: !Ref Environment4Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment5, {Name: !Ref Environment5Key, Value: !Ref Environment5Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment6, {Name: !Ref Environment6Key, Value: !Ref Environment6Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment7, {Name: !Ref Environment7Key, Value: !Ref Environment7Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment8, {Name: !Ref Environment8Key, Value: !Ref Environment8Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment9, {Name: !Ref Environment9Key, Value: !Ref Environment9Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment10, {Name: !Ref Environment10Key, Value: !Ref Environment10Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment11, {Name: !Ref Environment11Key, Value: !Ref Environment11Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment12, {Name: !Ref Environment12Key, Value: !Ref Environment12Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment13, {Name: !Ref Environment13Key, Value: !Ref Environment13Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment14, {Name: !Ref Environment14Key, Value: !Ref Environment14Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment15, {Name: !Ref Environment15Key, Value: !Ref Environment15Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment16, {Name: !Ref Environment16Key, Value: !Ref Environment16Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment17, {Name: !Ref Environment17Key, Value: !Ref Environment17Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment18, {Name: !Ref Environment18Key, Value: !Ref Environment18Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment19, {Name: !Ref Environment19Key, Value: !Ref Environment19Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment20, {Name: !Ref Environment20Key, Value: !Ref Environment20Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment21, {Name: !Ref Environment21Key, Value: !Ref Environment21Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment22, {Name: !Ref Environment22Key, Value: !Ref Environment22Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment23, {Name: !Ref Environment23Key, Value: !Ref Environment23Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment24, {Name: !Ref Environment24Key, Value: !Ref Environment24Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment25, {Name: !Ref Environment25Key, Value: !Ref Environment25Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment26, {Name: !Ref Environment26Key, Value: !Ref Environment26Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment27, {Name: !Ref Environment27Key, Value: !Ref Environment27Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment28, {Name: !Ref Environment28Key, Value: !Ref Environment28Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment29, {Name: !Ref Environment29Key, Value: !Ref Environment29Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment30, {Name: !Ref Environment30Key, Value: !Ref Environment30Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment31, {Name: !Ref Environment31Key, Value: !Ref Environment31Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment32, {Name: !Ref Environment32Key, Value: !Ref Environment32Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment33, {Name: !Ref Environment33Key, Value: !Ref Environment33Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment34, {Name: !Ref Environment34Key, Value: !Ref Environment34Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment35, {Name: !Ref Environment35Key, Value: !Ref Environment35Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment36, {Name: !Ref Environment36Key, Value: !Ref Environment36Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment37, {Name: !Ref Environment37Key, Value: !Ref Environment37Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment38, {Name: !Ref Environment38Key, Value: !Ref Environment38Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment39, {Name: !Ref Environment39Key, Value: !Ref Environment39Value}, !Ref 'AWS::NoValue']
              - !If [AddEnvironment40, {Name: !Ref Environment40Key, Value: !Ref Environment40Value}, !Ref 'AWS::NoValue']
            - !Ref 'AWS::NoValue'
          Secrets: !If
            - AddSecret1
            - - !If [AddSecret1, {Name: !Ref Secret1Name, ValueFrom: !Ref Secret1ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret2, {Name: !Ref Secret2Name, ValueFrom: !Ref Secret2ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret3, {Name: !Ref Secret3Name, ValueFrom: !Ref Secret3ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret4, {Name: !Ref Secret4Name, ValueFrom: !Ref Secret4ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret5, {Name: !Ref Secret5Name, ValueFrom: !Ref Secret5ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret6, {Name: !Ref Secret6Name, ValueFrom: !Ref Secret6ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret7, {Name: !Ref Secret7Name, ValueFrom: !Ref Secret7ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret8, {Name: !Ref Secret8Name, ValueFrom: !Ref Secret8ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret9, {Name: !Ref Secret9Name, ValueFrom: !Ref Secret9ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret10, {Name: !Ref Secret10Name, ValueFrom: !Ref Secret10ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret11, {Name: !Ref Secret11Name, ValueFrom: !Ref Secret11ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret12, {Name: !Ref Secret12Name, ValueFrom: !Ref Secret12ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret13, {Name: !Ref Secret13Name, ValueFrom: !Ref Secret13ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret14, {Name: !Ref Secret14Name, ValueFrom: !Ref Secret14ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret15, {Name: !Ref Secret15Name, ValueFrom: !Ref Secret15ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret16, {Name: !Ref Secret16Name, ValueFrom: !Ref Secret16ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret17, {Name: !Ref Secret17Name, ValueFrom: !Ref Secret17ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret18, {Name: !Ref Secret18Name, ValueFrom: !Ref Secret18ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret19, {Name: !Ref Secret19Name, ValueFrom: !Ref Secret19ValueFrom}, !Ref 'AWS::NoValue']
              - !If [AddSecret20, {Name: !Ref Secret20Name, ValueFrom: !Ref Secret20ValueFrom}, !Ref 'AWS::NoValue']
            - !Ref 'AWS::NoValue'
          HealthCheck: !If
            - EnableHealthCheckCondition
            - {Command: !Split [',', !Ref HealthCheckCommand], Interval: !Ref HealthCheckInterval, Timeout: !Ref HealthCheckTimeout, Retries: !Ref HealthCheckRetries, StartPeriod: !Ref HealthCheckStartPeriod}
            - !Ref 'AWS::NoValue'
          DependsOn: !If [EnableSidecarCondition, [{ContainerName: !Ref SidecarName, Condition: !Ref SidecarDependsOnCondition}], !Ref 'AWS::NoValue']
          LogConfiguration: !If
            - EnableLoggingCondition
            - LogDriver: awslogs
              Options: {awslogs-group: !Ref LogGroupName, awslogs-region: !Ref 'AWS::Region', awslogs-stream-prefix: !Ref LogStreamPrefix, mode: !Ref LogDriverMode, max-buffer-size: 25m, awslogs-create-group: !Ref EnableLogGroupAutoCreate}
            - !Ref 'AWS::NoValue'
          MountPoints: !If [EnableEfsVolumeCondition, [{SourceVolume: efs-volume, ContainerPath: !Ref EfsMountPath, ReadOnly: false}], !Ref 'AWS::NoValue']
          Ulimits: [{Name: nofile, SoftLimit: !Ref NoFileUlimitSoft, HardLimit: !Ref NoFileUlimitHard}]
          LinuxParameters: {InitProcessEnabled: true}
          DockerLabels: {com.example.environment: !Ref Environment, com.example.project: !Ref Project}
        - !If
          - EnableSidecarCondition
          - Name: !Ref SidecarName
            Image: !Ref SidecarImage
            Cpu: !Ref SidecarCpu
            Memory: !Ref SidecarMemory
            Essential: !Ref SidecarEssential
            Command: !If [HasSidecarCommand, !Split [',', !Ref SidecarCommand], !Ref 'AWS::NoValue']
            PortMappings: !If
              - HasSidecarPort1
              - - !If [HasSidecarPort1, {ContainerPort: !Ref SidecarPort1, Protocol: !Ref SidecarPort1Protocol, Name: !If [HasSidecarPort1, !Ref SidecarPort1Name, !Ref 'AWS::NoValue']}, !Ref 'AWS::NoValue']
                - !If [HasSidecarPort2, {ContainerPort: !Ref SidecarPort2, Protocol: !Ref SidecarPort2Protocol, Name: !If [HasSidecarPort2, !Ref SidecarPort2Name, !Ref 'AWS::NoValue']}, !Ref 'AWS::NoValue']
              - !Ref 'AWS::NoValue'
            Environment: !If
              - AddSidecarEnv1
              - - !If [AddSidecarEnv1, {Name: !Ref SidecarEnv1Key, Value: !Ref SidecarEnv1Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv2, {Name: !Ref SidecarEnv2Key, Value: !Ref SidecarEnv2Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv3, {Name: !Ref SidecarEnv3Key, Value: !Ref SidecarEnv3Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv4, {Name: !Ref SidecarEnv4Key, Value: !Ref SidecarEnv4Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv5, {Name: !Ref SidecarEnv5Key, Value: !Ref SidecarEnv5Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv6, {Name: !Ref SidecarEnv6Key, Value: !Ref SidecarEnv6Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv7, {Name: !Ref SidecarEnv7Key, Value: !Ref SidecarEnv7Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv8, {Name: !Ref SidecarEnv8Key, Value: !Ref SidecarEnv8Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv9, {Name: !Ref SidecarEnv9Key, Value: !Ref SidecarEnv9Value}, !Ref 'AWS::NoValue']
                - !If [AddSidecarEnv10, {Name: !Ref SidecarEnv10Key, Value: !Ref SidecarEnv10Value}, !Ref 'AWS::NoValue']
              - !Ref 'AWS::NoValue'
            LogConfiguration: !If
              - EnableLoggingCondition
              - LogDriver: awslogs
                Options: {awslogs-group: !If [HasSeparateSidecarLogGroup, !Ref SidecarLogGroupName, !Ref LogGroupName], awslogs-region: !Ref 'AWS::Region', awslogs-stream-prefix: !Ref SidecarLogStreamPrefix, mode: !Ref LogDriverMode, max-buffer-size: 25m, awslogs-create-group: !Ref EnableLogGroupAutoCreate}
              - !Ref 'AWS::NoValue'
          - !Ref 'AWS::NoValue'
      Volumes: !If
        - EnableEfsVolumeCondition
        - [{Name: efs-volume, EFSVolumeConfiguration: {FilesystemId: !Ref EfsVolumeId, RootDirectory: !Ref EfsRootDirectory, TransitEncryption: !Ref EfsTransitEncryption}}]
        - !Ref 'AWS::NoValue'
      Tags: [{Key: Name, Value: !Ref TaskDefinitionFamily},{Key: Environment, Value: !Ref Environment},{Key: Project, Value: !Ref Project},{Key: Owner, Value: !Ref Owner}]
Outputs:
  TaskDefinitionArn:
    Description: ARN of the Task Definition
    Value: !Ref TaskDefinition
    Export: {Name: !Sub '${AWS::StackName}-TaskDefinitionArn'}
  TaskDefinitionFamily:
    Description: Task Definition Family Name
    Value: !Ref TaskDefinitionFamily
    Export: {Name: !Sub '${AWS::StackName}-TaskDefinitionFamily'}
  TaskRoleArn:
    Description: ARN of the Task Role
    Value: !If [CreateNewTaskRole, !GetAtt TaskRole.Arn, !If [UseExistingTaskRole, !Ref ExistingTaskRoleArn, 'N/A']]
    Export: {Name: !Sub '${AWS::StackName}-TaskRoleArn'}
  ExecutionRoleArn:
    Description: ARN of the Execution Role
    Value: !If [CreateNewExecutionRole, !GetAtt ExecutionRole.Arn, !If [UseExistingExecutionRole, !Ref ExistingExecutionRoleArn, 'N/A']]
    Export: {Name: !Sub '${AWS::StackName}-ExecutionRoleArn'}
  LogGroupName:
    Condition: EnableLoggingCondition
    Description: CloudWatch Log Group Name
    Value: !Ref LogGroupName
    Export: {Name: !Sub '${AWS::StackName}-LogGroupName'}
  PrimaryContainerName:
    Description: Primary Container Name
    Value: !Ref Container1Name
    Export: {Name: !Sub '${AWS::StackName}-PrimaryContainerName'}
  PrimaryContainerPort:
    Description: Primary Container Port
    Value: !Ref Container1Port
    Export: {Name: !Sub '${AWS::StackName}-PrimaryContainerPort'}
