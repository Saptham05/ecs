AWSTemplateFormatVersion: '2010-09-09'
Description: 'Reusable Application Load Balancer CloudFormation Template'

Parameters:
  # Environment and Naming
  EnvironmentName:
    Type: String
    Description: Environment name (e.g., dev, staging, prod)
    AllowedValues:
      - dev
      - staging
      - prod
    Default: dev

  ApplicationName:
    Type: String
    Description: Application name for resource naming
    MinLength: 1
    MaxLength: 50

  # VPC and Network Configuration
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID where ALB will be deployed

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: List of subnet IDs for ALB (minimum 2 subnets in different AZs)

  # ALB Configuration
  ALBScheme:
    Type: String
    Description: ALB scheme (internet-facing or internal)
    AllowedValues:
      - internet-facing
      - internal
    Default: internet-facing

  ALBType:
    Type: String
    Description: ALB IP address type
    AllowedValues:
      - ipv4
      - dualstack
    Default: ipv4

  # Security Configuration
  AllowedCIDRBlocks:
    Type: CommaDelimitedList
    Description: Comma-separated list of CIDR blocks allowed to access ALB
    Default: 0.0.0.0/0

  # SSL/TLS Configuration
  EnableHTTPS:
    Type: String
    Description: Enable HTTPS listener
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'

  CertificateArn:
    Type: String
    Description: ACM Certificate ARN for HTTPS (required if EnableHTTPS is true)
    Default: ''

  SSLPolicy:
    Type: String
    Description: SSL security policy for HTTPS listener
    Default: ELBSecurityPolicy-TLS13-1-2-2021-06
    AllowedValues:
      - ELBSecurityPolicy-TLS13-1-2-2021-06
      - ELBSecurityPolicy-2016-08
      - ELBSecurityPolicy-TLS-1-2-2017-01
      - ELBSecurityPolicy-FS-1-2-Res-2020-10

  # Target Group Configuration
  TargetGroupProtocol:
    Type: String
    Description: Protocol for target group
    AllowedValues:
      - HTTP
      - HTTPS
    Default: HTTP

  TargetGroupPort:
    Type: Number
    Description: Port for target group
    Default: 80
    MinValue: 1
    MaxValue: 65535

  TargetType:
    Type: String
    Description: Type of targets
    AllowedValues:
      - instance
      - ip
      - lambda
    Default: instance

  # Health Check Configuration
  HealthCheckEnabled:
    Type: String
    Description: Enable health checks
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'

  HealthCheckProtocol:
    Type: String
    Description: Protocol for health checks
    AllowedValues:
      - HTTP
      - HTTPS
    Default: HTTP

  HealthCheckPath:
    Type: String
    Description: Path for health check
    Default: /health

  HealthCheckIntervalSeconds:
    Type: Number
    Description: Health check interval in seconds
    Default: 30
    MinValue: 5
    MaxValue: 300

  HealthCheckTimeoutSeconds:
    Type: Number
    Description: Health check timeout in seconds
    Default: 5
    MinValue: 2
    MaxValue: 120

  HealthyThresholdCount:
    Type: Number
    Description: Number of consecutive successful health checks
    Default: 2
    MinValue: 2
    MaxValue: 10

  UnhealthyThresholdCount:
    Type: Number
    Description: Number of consecutive failed health checks
    Default: 2
    MinValue: 2
    MaxValue: 10

  HealthCheckMatcherCode:
    Type: String
    Description: HTTP codes to use when checking for successful response
    Default: '200'

  # Target Group Attributes
  DeregistrationDelay:
    Type: Number
    Description: Deregistration delay in seconds
    Default: 300
    MinValue: 0
    MaxValue: 3600

  StickinessEnabled:
    Type: String
    Description: Enable sticky sessions
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'

  StickinessDuration:
    Type: Number
    Description: Stickiness duration in seconds
    Default: 86400
    MinValue: 1
    MaxValue: 604800

  # ALB Attributes
  EnableDeletionProtection:
    Type: String
    Description: Enable deletion protection
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'

  EnableHttp2:
    Type: String
    Description: Enable HTTP/2
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'

  EnableAccessLogs:
    Type: String
    Description: Enable access logs
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'

  AccessLogsBucketName:
    Type: String
    Description: S3 bucket name for access logs (required if EnableAccessLogs is true)
    Default: ''

  AccessLogsBucketPrefix:
    Type: String
    Description: S3 bucket prefix for access logs
    Default: alb-logs

  IdleTimeout:
    Type: Number
    Description: Idle timeout in seconds
    Default: 60
    MinValue: 1
    MaxValue: 4000

  # Tags
  CostCenter:
    Type: String
    Description: Cost center tag
    Default: ''

  Owner:
    Type: String
    Description: Owner tag
    Default: ''

Conditions:
  HasHTTPS: !Equals [!Ref EnableHTTPS, 'true']
  HasAccessLogs: !Equals [!Ref EnableAccessLogs, 'true']
  HasStickiness: !Equals [!Ref StickinessEnabled, 'true']
  HasCostCenter: !Not [!Equals [!Ref CostCenter, '']]
  HasOwner: !Not [!Equals [!Ref Owner, '']]

Resources:
  # Security Group for ALB
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ApplicationName}-${EnvironmentName}-alb-sg'
      GroupDescription: !Sub 'Security group for ${ApplicationName} ALB in ${EnvironmentName}'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Select [0, !Ref AllowedCIDRBlocks]
          Description: Allow HTTP traffic
        - !If
          - HasHTTPS
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: !Select [0, !Ref AllowedCIDRBlocks]
            Description: Allow HTTPS traffic
          - !Ref AWS::NoValue
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${EnvironmentName}-alb-sg'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ApplicationName
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${ApplicationName}-${EnvironmentName}-alb'
      Type: application
      Scheme: !Ref ALBScheme
      IpAddressType: !Ref ALBType
      Subnets: !Ref SubnetIds
      SecurityGroups:
        - !Ref ALBSecurityGroup
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: !Ref EnableDeletionProtection
        - Key: routing.http2.enabled
          Value: !Ref EnableHttp2
        - Key: idle_timeout.timeout_seconds
          Value: !Ref IdleTimeout
        - !If
          - HasAccessLogs
          - Key: access_logs.s3.enabled
            Value: 'true'
          - Key: access_logs.s3.enabled
            Value: 'false'
        - !If
          - HasAccessLogs
          - Key: access_logs.s3.bucket
            Value: !Ref AccessLogsBucketName
          - !Ref AWS::NoValue
        - !If
          - HasAccessLogs
          - Key: access_logs.s3.prefix
            Value: !Ref AccessLogsBucketPrefix
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${EnvironmentName}-alb'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ApplicationName
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # Target Group
  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${ApplicationName}-${EnvironmentName}-tg'
      Protocol: !Ref TargetGroupProtocol
      Port: !Ref TargetGroupPort
      VpcId: !Ref VpcId
      TargetType: !Ref TargetType
      HealthCheckEnabled: !Ref HealthCheckEnabled
      HealthCheckProtocol: !Ref HealthCheckProtocol
      HealthCheckPath: !Ref HealthCheckPath
      HealthCheckIntervalSeconds: !Ref HealthCheckIntervalSeconds
      HealthCheckTimeoutSeconds: !Ref HealthCheckTimeoutSeconds
      HealthyThresholdCount: !Ref HealthyThresholdCount
      UnhealthyThresholdCount: !Ref UnhealthyThresholdCount
      Matcher:
        HttpCode: !Ref HealthCheckMatcherCode
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: !Ref DeregistrationDelay
        - !If
          - HasStickiness
          - Key: stickiness.enabled
            Value: 'true'
          - Key: stickiness.enabled
            Value: 'false'
        - !If
          - HasStickiness
          - Key: stickiness.type
            Value: lb_cookie
          - !Ref AWS::NoValue
        - !If
          - HasStickiness
          - Key: stickiness.lb_cookie.duration_seconds
            Value: !Ref StickinessDuration
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-${EnvironmentName}-tg'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ApplicationName
        - !If
          - HasCostCenter
          - Key: CostCenter
            Value: !Ref CostCenter
          - !Ref AWS::NoValue
        - !If
          - HasOwner
          - Key: Owner
            Value: !Ref Owner
          - !Ref AWS::NoValue

  # HTTP Listener
  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Protocol: HTTP
      Port: 80
      DefaultActions:
        - !If
          - HasHTTPS
          - Type: redirect
            RedirectConfig:
              Protocol: HTTPS
              Port: '443'
              StatusCode: HTTP_301
          - Type: forward
            TargetGroupArn: !Ref TargetGroup

  # HTTPS Listener (conditional)
  HTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: HasHTTPS
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Protocol: HTTPS
      Port: 443
      SslPolicy: !Ref SSLPolicy
      Certificates:
        - CertificateArn: !Ref CertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

Outputs:
  ALBArn:
    Description: ARN of the Application Load Balancer
    Value: !Ref ApplicationLoadBalancer
    Export:
      Name: !Sub '${AWS::StackName}-ALB-Arn'

  ALBDNSName:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-ALB-DNSName'

  ALBHostedZoneID:
    Description: Hosted Zone ID of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
    Export:
      Name: !Sub '${AWS::StackName}-ALB-HostedZoneID'

  ALBFullName:
    Description: Full name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
    Export:
      Name: !Sub '${AWS::StackName}-ALB-FullName'

  TargetGroupArn:
    Description: ARN of the Target Group
    Value: !Ref TargetGroup
    Export:
      Name: !Sub '${AWS::StackName}-TargetGroup-Arn'

  TargetGroupFullName:
    Description: Full name of the Target Group
    Value: !GetAtt TargetGroup.TargetGroupFullName
    Export:
      Name: !Sub '${AWS::StackName}-TargetGroup-FullName'

  ALBSecurityGroupId:
    Description: Security Group ID of the ALB
    Value: !Ref ALBSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ALB-SecurityGroup-Id'

  HTTPListenerArn:
    Description: ARN of the HTTP Listener
    Value: !Ref HTTPListener
    Export:
      Name: !Sub '${AWS::StackName}-HTTP-Listener-Arn'

  HTTPSListenerArn:
    Description: ARN of the HTTPS Listener (if enabled)
    Value: !If [HasHTTPS, !Ref HTTPSListener, 'N/A']
    Export:
      Name: !Sub '${AWS::StackName}-HTTPS-Listener-Arn'

  ALBURL:
    Description: URL of the Application Load Balancer
    Value: !Sub 
      - '${Protocol}://${DNSName}'
      - Protocol: !If [HasHTTPS, 'https', 'http']
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-ALB-URL'
