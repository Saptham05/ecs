name: ALB CloudFormation Pipeline

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create
          - update
          - delete
          - validate
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      stack_name:
        description: 'CloudFormation stack name'
        required: false
        type: string

env:
  AWS_REGION: ap-south-1
  TEMPLATE_FILE: cloudformation/alb-cft.yaml
  PARAMETER_FILE: cloudformation/alb-parameters.json
  
jobs:
  # Job 1: Validate CloudFormation Template
  validate:
    name: Validate CloudFormation Template
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ALB-Validate
      
      - name: Validate CloudFormation Template
        run: |
          echo "ðŸ” Validating CloudFormation template..."
          aws cloudformation validate-template \
            --template-body file://${{ env.TEMPLATE_FILE }} \
            --region ${{ env.AWS_REGION }}
          echo "âœ… Template validation successful!"
      
      - name: Install cfn-lint
        run: |
          pip install cfn-lint
      
      - name: Lint CloudFormation Template
        run: |
          echo "ðŸ” Linting CloudFormation template..."
          cfn-lint ${{ env.TEMPLATE_FILE }}
          echo "âœ… Template linting successful!"

  # Job 2: Setup Deployment Configuration
  setup:
    name: Setup Deployment Configuration
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      action: ${{ steps.set-action.outputs.action }}
      stack_name: ${{ steps.set-stack.outputs.stack_name }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set Environment
        id: set-env
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Environment: ${ENVIRONMENT}"
      
      - name: Set Action
        id: set-action
        run: |
          ACTION="${{ github.event.inputs.action }}"
          echo "action=${ACTION}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Action: ${ACTION}"
      
      - name: Set Stack Name
        id: set-stack
        run: |
          if [[ -n "${{ github.event.inputs.stack_name }}" ]]; then
            STACK_NAME="${{ github.event.inputs.stack_name }}"
          else
            STACK_NAME="alb-${{ github.event.inputs.environment }}"
          fi
          echo "stack_name=${STACK_NAME}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Stack Name: ${STACK_NAME}"

  # Job 3: Create or Update Stack
  deploy:
    name: Deploy ALB Stack
    runs-on: ubuntu-latest
    needs: setup
    if: |
      needs.setup.outputs.action == 'create' || 
      needs.setup.outputs.action == 'update' || 
      needs.setup.outputs.action == 'create-or-update'
    environment: ${{ needs.setup.outputs.environment }}
    
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ALB-Deploy
      
      - name: Verify AWS Identity
        run: |
          echo "ðŸ” Verifying AWS Identity..."
          aws sts get-caller-identity
      
      - name: Check if Stack Exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} 2>&1 | grep -q "does not exist"; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Stack does not exist - will create new stack"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Stack exists - will update stack"
          fi
      
      - name: Create CloudFormation Stack
        if: steps.check-stack.outputs.exists == 'false'
        run: |
          echo "ðŸš€ Creating CloudFormation stack: ${{ needs.setup.outputs.stack_name }}"
          aws cloudformation create-stack \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --template-body file://${{ env.TEMPLATE_FILE }} \
            --parameters file://${{ env.PARAMETER_FILE }} \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --tags \
              Key=Environment,Value=${{ needs.setup.outputs.environment }} \
              Key=ManagedBy,Value=GitHubActions \
              Key=Repository,Value=${{ github.repository }} \
              Key=CommitSHA,Value=${{ github.sha }} \
              Key=DeployedBy,Value=${{ github.actor }} \
            --region ${{ env.AWS_REGION }}
          
          echo "â³ Waiting for stack creation to complete..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Stack created successfully!"
      
      - name: Update CloudFormation Stack
        if: steps.check-stack.outputs.exists == 'true'
        run: |
          echo "ðŸ”„ Updating CloudFormation stack: ${{ needs.setup.outputs.stack_name }}"
          
          # Create change set
          CHANGE_SET_NAME="${{ needs.setup.outputs.stack_name }}-$(date +%Y%m%d%H%M%S)"
          
          aws cloudformation create-change-set \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --change-set-name ${CHANGE_SET_NAME} \
            --template-body file://${{ env.TEMPLATE_FILE }} \
            --parameters file://${{ env.PARAMETER_FILE }} \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --tags \
              Key=Environment,Value=${{ needs.setup.outputs.environment }} \
              Key=ManagedBy,Value=GitHubActions \
              Key=Repository,Value=${{ github.repository }} \
              Key=CommitSHA,Value=${{ github.sha }} \
              Key=DeployedBy,Value=${{ github.actor }} \
            --region ${{ env.AWS_REGION }}
          
          echo "â³ Waiting for change set creation..."
          aws cloudformation wait change-set-create-complete \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --change-set-name ${CHANGE_SET_NAME} \
            --region ${{ env.AWS_REGION }} || {
            # Check if change set failed due to no changes
            STATUS=$(aws cloudformation describe-change-set \
              --stack-name ${{ needs.setup.outputs.stack_name }} \
              --change-set-name ${CHANGE_SET_NAME} \
              --region ${{ env.AWS_REGION }} \
              --query 'Status' --output text)
            
            if [[ "$STATUS" == "FAILED" ]]; then
              REASON=$(aws cloudformation describe-change-set \
                --stack-name ${{ needs.setup.outputs.stack_name }} \
                --change-set-name ${CHANGE_SET_NAME} \
                --region ${{ env.AWS_REGION }} \
                --query 'StatusReason' --output text)
              
              if [[ "$REASON" == *"didn't contain changes"* ]]; then
                echo "â„¹ï¸  No changes detected - stack is already up to date"
                aws cloudformation delete-change-set \
                  --stack-name ${{ needs.setup.outputs.stack_name }} \
                  --change-set-name ${CHANGE_SET_NAME} \
                  --region ${{ env.AWS_REGION }}
                exit 0
              else
                echo "âŒ Change set creation failed: $REASON"
                exit 1
              fi
            fi
          }
          
          # Describe changes
          echo "ðŸ“‹ Change Set Details:"
          aws cloudformation describe-change-set \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --change-set-name ${CHANGE_SET_NAME} \
            --region ${{ env.AWS_REGION }} \
            --query 'Changes[*].[ResourceChange.Action,ResourceChange.LogicalResourceId,ResourceChange.ResourceType,ResourceChange.Replacement]' \
            --output table
          
          # Execute change set
          echo "ðŸš€ Executing change set..."
          aws cloudformation execute-change-set \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --change-set-name ${CHANGE_SET_NAME} \
            --region ${{ env.AWS_REGION }}
          
          echo "â³ Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Stack updated successfully!"
      
      - name: Get Stack Outputs
        run: |
          echo "ðŸ“Š Stack Outputs:"
          aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue,Description]' \
            --output table
      
      - name: Get ALB Details
        id: alb-details
        run: |
          # Get ALB DNS Name
          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ALBDNSName`].OutputValue' \
            --output text)
          echo "dns_name=${ALB_DNS}" >> $GITHUB_OUTPUT
          echo "ðŸŒ ALB DNS Name: ${ALB_DNS}"
          
          # Get ALB ARN
          ALB_ARN=$(aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ALBArn`].OutputValue' \
            --output text)
          echo "arn=${ALB_ARN}" >> $GITHUB_OUTPUT
          echo "ðŸ”— ALB ARN: ${ALB_ARN}"
          
          # Get Target Group ARN
          TG_ARN=$(aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TargetGroupArn`].OutputValue' \
            --output text)
          echo "target_group_arn=${TG_ARN}" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Target Group ARN: ${TG_ARN}"
      
      - name: Create Deployment Summary
        run: |
          echo "## ðŸš€ ALB Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Stack Name:** ${{ needs.setup.outputs.stack_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ needs.setup.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ALB Details" >> $GITHUB_STEP_SUMMARY
          echo "- **DNS Name:** ${{ steps.alb-details.outputs.dns_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ALB ARN:** ${{ steps.alb-details.outputs.arn }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Group ARN:** ${{ steps.alb-details.outputs.target_group_arn }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY

  # Job 4: Delete Stack
  delete:
    name: Delete ALB Stack
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.action == 'delete'
    environment: ${{ needs.setup.outputs.environment }}
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ALB-Delete
      
      - name: Verify AWS Identity
        run: |
          echo "ðŸ” Verifying AWS Identity..."
          aws sts get-caller-identity
      
      - name: Check if Stack Exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} 2>&1 | grep -q "does not exist"; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Stack does not exist - nothing to delete"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Stack exists - proceeding with deletion"
          fi
      
      - name: Check Deletion Protection
        if: steps.check-stack.outputs.exists == 'true'
        id: check-protection
        run: |
          echo "ðŸ” Checking if deletion protection is enabled..."
          DELETION_PROTECTION=$(aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].EnableTerminationProtection' \
            --output text 2>&1 || echo "false")
          
          if [[ "$DELETION_PROTECTION" == "True" ]]; then
            echo "âš ï¸  WARNING: Deletion protection is enabled!"
            echo "Disabling deletion protection..."
            aws cloudformation update-termination-protection \
              --no-enable-termination-protection \
              --stack-name ${{ needs.setup.outputs.stack_name }} \
              --region ${{ env.AWS_REGION }}
            echo "âœ… Deletion protection disabled"
          else
            echo "âœ… No deletion protection - safe to delete"
          fi
      
      - name: Get Stack Resources Before Deletion
        if: steps.check-stack.outputs.exists == 'true'
        run: |
          echo "ðŸ“‹ Stack Resources to be deleted:"
          aws cloudformation describe-stack-resources \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'StackResources[*].[LogicalResourceId,ResourceType,PhysicalResourceId]' \
            --output table
      
      - name: Confirm Deletion
        if: steps.check-stack.outputs.exists == 'true'
        run: |
          echo "âš ï¸  WARNING: You are about to DELETE the following stack:"
          echo "Stack Name: ${{ needs.setup.outputs.stack_name }}"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""
          echo "This action will delete all resources in the stack!"
          echo "Proceeding with deletion in 5 seconds..."
          sleep 5
      
      - name: Delete CloudFormation Stack
        if: steps.check-stack.outputs.exists == 'true'
        run: |
          echo "ðŸ—‘ï¸  Deleting CloudFormation stack: ${{ needs.setup.outputs.stack_name }}"
          aws cloudformation delete-stack \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "â³ Waiting for stack deletion to complete..."
          aws cloudformation wait stack-delete-complete \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Stack deleted successfully!"
      
      - name: Verify Deletion
        if: steps.check-stack.outputs.exists == 'true'
        run: |
          if aws cloudformation describe-stacks \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} 2>&1 | grep -q "does not exist"; then
            echo "âœ… Verified: Stack has been deleted"
          else
            echo "âš ï¸  Warning: Stack still exists"
            exit 1
          fi
      
      - name: Create Deletion Summary
        run: |
          echo "## ðŸ—‘ï¸ ALB Stack Deletion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Stack Name:** ${{ needs.setup.outputs.stack_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check-stack.outputs.exists }}" == "true" ]]; then
            echo "âœ… **Stack deleted successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  **Stack did not exist - no action taken**" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 5: Drift Detection (only after successful deployment)
  drift-detection:
    name: Detect Stack Drift
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: |
      always() && 
      (needs.setup.outputs.action == 'create' || 
       needs.setup.outputs.action == 'update' || 
       needs.setup.outputs.action == 'create-or-update') &&
      needs.deploy.result == 'success'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ALB-Drift
      
      - name: Detect Drift
        run: |
          echo "ðŸ” Starting drift detection..."
          DRIFT_ID=$(aws cloudformation detect-stack-drift \
            --stack-name ${{ needs.setup.outputs.stack_name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'StackDriftDetectionId' \
            --output text)
          
          echo "â³ Waiting for drift detection to complete..."
          sleep 15
          
          # Check drift detection status
          DRIFT_STATUS=$(aws cloudformation describe-stack-drift-detection-status \
            --stack-drift-detection-id ${DRIFT_ID} \
            --region ${{ env.AWS_REGION }} \
            --query 'StackDriftStatus' \
            --output text)
          
          echo "ðŸ“Š Drift Status: ${DRIFT_STATUS}"
          
          if [[ "${DRIFT_STATUS}" == "DRIFTED" ]]; then
            echo "âš ï¸  Stack has drifted from expected configuration!"
            echo ""
            echo "Drifted Resources:"
            aws cloudformation describe-stack-resource-drifts \
              --stack-name ${{ needs.setup.outputs.stack_name }} \
              --region ${{ env.AWS_REGION }} \
              --stack-resource-drift-status-filters MODIFIED DELETED \
              --query 'StackResourceDrifts[*].[LogicalResourceId,ResourceType,StackResourceDriftStatus]' \
              --output table
          elif [[ "${DRIFT_STATUS}" == "IN_SYNC" ]]; then
            echo "âœ… No drift detected - stack is in sync"
          else
            echo "â„¹ï¸  Drift Status: ${DRIFT_STATUS}"
          fi

  # Job 6: Notification
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [setup, deploy, delete]
    if: always()
    
    steps:
      - name: Set Notification Status
        id: status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]] || [[ "${{ needs.delete.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.deploy.result }}" == "failure" ]] || [[ "${{ needs.delete.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          else
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "emoji=â„¹ï¸" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Final Summary
        run: |
          echo "## ${{ steps.status.outputs.emoji }} Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ needs.setup.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Stack:** ${{ needs.setup.outputs.stack_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.status.outputs.status }}" == "success" ]]; then
            echo "### âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "Pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.status.outputs.status }}" == "failure" ]]; then
            echo "### âŒ Failure" >> $GITHUB_STEP_SUMMARY
            echo "Pipeline failed. Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ Validation Only" >> $GITHUB_STEP_SUMMARY
            echo "Template validation completed." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Job Status
        run: |
          if [[ "${{ steps.status.outputs.status }}" == "failure" ]]; then
            exit 1
          fi
